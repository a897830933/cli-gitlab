// Generated by CoffeeScript 1.7.1
var checkOptions, configFilePath, fs, getMe, getObjectByNameSpaces, gitlab, gitlabDircPath, nconf, path, requireOrGetGitlab, _;

nconf = require("nconf");

fs = require("fs");

path = require("path");

_ = require("underscore");

gitlabDircPath = path.join(process.env[(process.platform === "win32" ? "USERPROFILE" : "HOME")], ".gitlab");

if (!fs.existsSync(gitlabDircPath)) {
  fs.mkdirSync(gitlabDircPath);
}

configFilePath = path.join(gitlabDircPath, "config.json");

nconf.file({
  file: configFilePath
});

gitlab = null;

checkOptions = function() {
  if (!nconf.get("url")) {
    console.log("You should set url by 'gitlab url http://example.com' ");
    return false;
  }
  if (!nconf.get("token")) {
    console.log("You should set token by 'gitlab token abcdefghij123456' ");
    return false;
  }
  return true;
};

requireOrGetGitlab = function() {
  if (gitlab != null) {
    return gitlab;
  } else {
    if (checkOptions()) {
      gitlab = require("gitlab")({
        url: nconf.get("url"),
        token: nconf.get("token")
      });
      return gitlab;
    }
  }
};

exports.url = function(url) {
  if (url != null) {
    nconf.set("url", url);
    nconf.save();
    return console.log("Save url");
  } else {
    return console.log(nconf.get("url"));
  }
};

exports.token = function(token) {
  if (token != null) {
    nconf.set("token", token);
    nconf.save();
    console.log("Save token");
    gitlab = requireOrGetGitlab();
    return gitlab.users.current(function(data) {
      nconf.set("me", JSON.stringify(data));
      return nconf.save();
    });
  } else {
    return console.log(nconf.get("token"));
  }
};

getMe = function() {
  var me;
  me = nconf.get("me");
  if (me != null) {
    return JSON.parse(me);
  } else {
    console.log("Please save token again!");
    return null;
  }
};

getObjectByNameSpaces = function(currentObject, nameSpaces) {
  var name, object, _i, _len;
  object = currentObject;
  nameSpaces = nameSpaces.split(".");
  for (_i = 0, _len = nameSpaces.length; _i < _len; _i++) {
    name = nameSpaces[_i];
    object = object[name];
  }
  return object;
};

exports.getOption = function() {
  var key, opitons, value, _results;
  opitons = nconf.get();
  _results = [];
  for (key in opitons) {
    value = opitons[key];
    _results.push(console.log("" + key + ":" + value));
  }
  return _results;
};

exports.createOptions = function(program, param) {
  var key, value, _results;
  _results = [];
  for (key in param) {
    value = param[key];
    _results.push(program.option((value.alias != null ? "-" + value.alias + "," : "") + (" --" + key + " " + (value.param != null ? value.param : '')), value.desc));
  }
  return _results;
};

exports.createParam = function(params) {
  var item, ret, _i, _len;
  if (params == null) {
    return "";
  }
  ret = [];
  for (_i = 0, _len = params.length; _i < _len; _i++) {
    item = params[_i];
    ret.push(item);
  }
  return ret.join(" ");
};

exports.createCommands = function(map, program) {
  return _.forEach(map, function(cmd, key) {
    var command;
    command = program.command("" + key + " " + (exports.createParam(cmd.param)));
    command.description(cmd.desc);
    if (cmd.help != null) {
      command.on("--help", cmd.help);
    }
    if (cmd.options == null) {
      cmd.options = {};
    }
    if (cmd.assigned_to_me != null) {
      cmd.options.assigned_to_me = {
        type: true,
        desc: "(optional) - Filter result if assigned to me."
      };
    }
    if (cmd.created_by_me != null) {
      cmd.options.created_by_me = {
        type: true,
        desc: "(optional) - Filter result if created by me."
      };
    }
    if (cmd.size != null) {
      cmd.options.size = {
        type: true,
        desc: "(optional) - Output size of result."
      };
    }
    if (cmd.filter === true) {
      cmd.options.filter = {
        param: "<filter>",
        type: true,
        desc: "(required) - Filter result. For example: --filter 'item.assignee.id == 9' "
      };
    }
    exports.createOptions(command, cmd.options);
    return command.action(function() {
      var arg, callback, fn, i, name, nameSpaces, options, target, value, _i, _len, _ref;
      options = arguments[arguments.length - 1] || {};
      arg = [];
      if ((cmd.param != null) && typeof arguments[0] !== "object") {
        i = 0;
        while (typeof arguments[i] !== "object") {
          arg.push(arguments[i]);
          i++;
        }
      }
      _ref = cmd.options;
      for (key in _ref) {
        value = _ref[key];
        if (value.index == null) {
          continue;
        }
        if (value.type) {
          if (arg[value.index] == null) {
            arg[value.index] = {};
          }
          if (options[key] != null) {
            arg[value.index][key] = options[key];
          }
        } else {
          if (options[key] != null) {
            arg[value.index] = options[key];
          }
        }
      }
      target = requireOrGetGitlab();
      nameSpaces = cmd.nameSpaces.split(".");
      fn = nameSpaces.pop();
      if (cmd.callback != null) {
        callback = cmd.callback;
        arg.push(function(data) {
          var evalFn, evalFnString;
          if (cmd.filter === true && (options != null) && (options.filter != null)) {
            evalFnString = "(function(item){ return " + options.filter + "; });";
            evalFn = eval(evalFnString);
            data = _.filter(data, evalFn);
          }
          if ((cmd.assigned_to_me != null) && (options.assigned_to_me != null)) {
            data = _.filter(data, function(item) {
              return getObjectByNameSpaces(item, cmd.assigned_to_me) === getMe().id;
            });
          }
          if ((cmd.created_by_me != null) && (options.created_by_me != null)) {
            data = _.filter(data, function(item) {
              return getObjectByNameSpaces(item, cmd.created_by_me) === getMe().id;
            });
          }
          callback(data);
          if ((cmd.size != null) && (options.size != null)) {
            return console.log(data.length);
          }
        });
      }
      for (_i = 0, _len = nameSpaces.length; _i < _len; _i++) {
        name = nameSpaces[_i];
        target = target[name];
      }
      return target[fn].apply(target, arg);
    });
  });
};

exports.getOption = function() {
  var key, opitons, value, _results;
  opitons = nconf.get();
  _results = [];
  for (key in opitons) {
    value = opitons[key];
    _results.push(console.log("" + key + ":" + value));
  }
  return _results;
};
